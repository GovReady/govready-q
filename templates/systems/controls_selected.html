{% extends "project-base.html" %}
{% load humanize %}
{% load guardian_tags %}
{% load static %}
{% load q %}
{% load system_tags %}

{% block title %}
  Controls Selected
{% endblock %}

{% block head %}
{{block.super}}
{% include "controls/_style-controls.html" %}
<style>{% include 'bootstrap-extensions.css' %}</style>
{% endblock %}

<!-- action buttons included from project-base.html -->
<!-- authoring_tool_enabled included from project-base.html -->

{% block body_content %}
  <div class="systems-top">
    <div id="tab-content" class="bootstrap-extension row rows-header">
        <!-- Horizontal for wider / Stacked for narrower widths  w/ Download always upper right -->

        <div class="col-auto align-self-end mr-auto"><span class="systems-table-title">Controls</span></div>

        <div class="col-12 order-last  col-xl order-xl-first">
          <form id="add-form" class="form-inline" method="post"
                action="{%  url 'system_controls_add' system_id=system.id %}">
            {% csrf_token %}
            <select title="Add" id="add-control_id-select" name="control_id" style="width: 100%">
              <!-- script'd to select2 w/ search & submit  (style=width:100% instead of class per select2 docs) -->
              <option value="None" selected disabled hidden>Add</option>
            </select>
            <input type="hidden" id="add-catalog_key-input" name="catalog_key">
          </form>
        </div>

        <!-- Download button  on upper right -->
        <div class="col-auto align-self-end ml-auto  ml-sm-0"> <!-- Vertically center -->
          <!--a href="selected/export/xacta/xlsx">export</a-->
          <span title="Download"
                class="glyphicon glyphicon-download-alt" style="cursor: pointer"
                onclick="download_document('{{document.id|escapejs}}', {{ system.id }})"></span>
        </div>
    </div>

    {% if controls|length < 1 %}
      <div id="tab-content" class="row row-control">
        <div class="col-xs-12">
          <p>No controls are currently selected for this system.</p>
          <p>FEATURE NOTE: We are automating the assigning of control baselines by system categorization.
          Prior to feature completion, we humbly ask you manually select the desired control baseline...</p>
          <ul>
            <li><a href={% url 'assign_baseline' system_id=system.id catalog_key='NIST_SP-800-53_rev4' baseline_name='low' %}>Assign 800-53 rev4 Low Impact Baseline</a></li>
            <li><a href={% url 'assign_baseline' system_id=system.id catalog_key='NIST_SP-800-53_rev4' baseline_name='moderate' %}>Assign 800-53 rev4 Moderate Impact Baseline</a></li>
            <li><a href={% url 'assign_baseline' system_id=system.id catalog_key='NIST_SP-800-53_rev4' baseline_name='high' %}>Assign 800-53 rev4 High Impact Baseline</a></li>
            <li><a href={% url 'assign_baseline' system_id=system.id catalog_key='NIST_SP-800-171_rev1' baseline_name='cui' %}>Assign 800-171 rev1 Baseline</a></li>
          </ul>
        </div>
      </div>
    {% else %}
      {% for control in controls %}
        <div id="tab-content" class="bootstrap-extension row row-control">
            <!-- Horizontal for wider / Stacked progressively for narrower widths -->

            {% with control_oscal=control.get_flattened_oscal_control_as_dict %}
            <div class="col-auto order--3  col-sm-em-5">
              <!-- Fixed width for up to 'AC-16 (10) ' -->
              <a href= {% url 'control_editor' system_id=system.id catalog_key=control.oscal_catalog_key cl_id=control.oscal_ctl_id %}
              >{{ control_oscal.id_display }}</a>
            </div>

            <div class="col-12  offset-sm-1 col-sm-10-64  offset-xl-0 col-xl order-xl--2">
              <div class="row">
                <div class="col-12 mb-3  col-xl mb-xl-0"> <!-- Bottom margin for stacked layout -->
                    {{ control_oscal.title }}
                </div>
            {% endwith %}

                <div class="col-min ml-auto  col-sm-max  ml-xl-4"> <!-- Left margin fixed for horizontal layout -->
                  <div class="row">
                    <div class="col-max-em-8-5 mb-3  col-sm-min-em-8-5 mb-sm-0"> <!-- Bottom margin for stacked layout -->
                      <!-- Fixed width for up to '1000 components ' -->
                      {% with total=impl_smts_count|get_item:control.oscal_ctl_id %}
                        {% if total > 0%}
                          {{ total }} component{{ total|pluralize }}
                        {% else %}
                          <div class="text-left text-sm-center"> <!-- Left align for stacked layout -->
                            &mdash;
                          </div>
                        {% endif %}
                      {% endwith %}
                    </div>

                    <div class="col-max-em-12 col-sm-min-em-12">
                      <!-- Fixed width for up to '12 months, 59 minutes ago ' -->
                      {% if control.smts_updated %}
                        {{ control.smts_updated|timesince}} ago
                      {% else %}
                        {{ control.created|timesince}} ago
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>


          {% get_obj_perms request.user for system as 'system_perms' %}
          {% if 'change_system' in system_perms %}
            <div class="col-auto order--1 mt-2  ml-auto ml-xl-0"> <!-- Top align with name -->
              {% with control_id_string=control.id|stringformat:'s' %}
              {% with form_id='remove-'|add:control_id_string|add:'-form' %}
              {% url 'system_controls_remove' system_id=system.id control_id=control.id as remove_url %}
              <form id="{{ form_id }}" class="form-inline" method="post" action="{{ remove_url }}">
                {% csrf_token %}
                <a title="Remove" href="{{ remove_url }}"
                    onclick="return remove('{{ control.get_name_with_catalog }}', '{{ form_id }}')"
                  ><span class="glyphicon glyphicon-trash"></span></a>
              </form>
              {% endwith %}
              {% endwith %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  // Add:  Convert form select to jQuery Select2
  $(document).ready(function() {
    $('#add-control_id-select').select2({
      // Initially, show all Controls that haven't been added
      //
      //   Note: Not caching 1st/full listing so results always reflect the latest
      language:         { inputTooShort: function() { return 'Please enter your search'; } },
      ajax: {
        url:            '{%  url 'controls_system_addable_search' system_id=system.id %}',
        dataType:       'json',
        delay:          250,
        data:           function(params)       { return { q:       params.term }; },
        processResults: function(data, params) { return { results: data.data.controls }; }
      }
    }).on('select2:select', function (e) {
      // After change event for which e.params isn't defined
      $('#add-catalog_key-input').val(e.params.data.catalog_key);
      $('#add-form').submit();
    });
  });

  // The download button shows a modal to ask what file format to download in.
  function download_document(document_id, system_id) {
    var dom = $("<div><p>Select download format:</p>"
      + "<select class=form-control>"
      {% if enable_experimental_opencontrol %}
      + "<option value='opencontrol'>OpenControl Repository</option>"
      {% endif %}
      + "<option value='xacta'>Xacta Import Spreadsheet</option>"
      + "</select>"
      + "</div>");
    show_modal_confirm("Download Document", dom, "Download", function() {
      var format = dom.find("select").val();
      switch(format) {
        case "opencontrol":
          window.location = "/systems/" + system_id + "/components/selected/export/opencontrol";
          break;
        case "xacta":
          window.location = "selected/export/" + format + "/xlsx";
          break;
      }
    });
  }

  function remove(control_name, form_id) {
    if (confirm("Remove "+control_name+"  &  Delete this System's related Component associations & Statement customizations?"))
      $('#'+form_id).submit();

    return false;  // so href link not requested
  }
</script>
{% endblock %}