{% extends "task-base.html" %}
{% load static %}
{% load q %}

{% block title %}
Next Question: {% for q in questions %}{{q.question.spec.title}}{% if not forloop.last %}, {% endif %}{% endfor %} | {{task.title}}
{% endblock %}

{% block head %}

<link href="{% static "vendor/emojione/emojione-sprite-24.min.css" %}" rel="stylesheet">
<link href="{% static "vendor/quill/quill.snow.css" %}" rel="stylesheet">

{{block.super}}

<style>
#focus-area-wrapper {
  /* on mobile, space between columns */
  margin-bottom: 30px;
}

h1 {
  margin: 4px 0 18px 0;
  font-size: 22px;
  font-weight: bold;
}

h2 {
  margin: 3px 0 12px 0;
  font-size: 18px;
}

.form-control {
  font-size: 14pt;
  height: 34pt;
}

.question {
  font-size: 14pt;
}
  .question form.disabled label {
    color: #777;
    cursor: not-allowed;
  }

.question-prompt blockquote {
  font-size: inherit;
}

/* since prompts will likely use Markdown ##'s to delimit sections,
    which we render as h3 because we demote all levels, re-adjust
    styles */
.question-prompt h3 {
  font-size: 110%;
  font-weight: bold;
}

.question.type-module .radio label {
  margin: .25em 0;
}

  .question.type-interstitial img {
    display: block; /* so that horizontal auto margin centers */
    margin: 30px auto;
  }

.question.type-longtext .ql-container {
  font-size: 14pt !important; /* override default quill style */
}
.question.type-longtext .ql-container p {
  margin-bottom: .75em;
}
  .question.type-longtext .ql-container p:last-child {
    margin-bottom: 0;
  }

label .onhover { display: none; }
label:hover .onhover { display: inline; }

.confidence-buttons {
  margin: 0 0 30px 0;
}
    .confidence-buttons button {
        border: 1px solid rgba(255,255,255,0); /* same width as .active but no color */
        border-radius: 4px;
        padding: 6px 6px 4px 4px;
        font-size: 80%;
        background: none;
        opacity: .6;
        margin-right: .5em;
    }
        .confidence-buttons button img {
            height: 1.25em;
            margin-right: .25em;
        }
        .confidence-buttons button.active {
            border: 1px solid #AAA;
            color: black;
            background: #EEE;
            opacity: 1;
        }
        .confidence-buttons:hover button {
            border: 1px solid #AAA;
            opacity: 1;
        }

#action-buttons {
  margin: 25px 0;
}

#discussion {
  margin-top: 1em;
  /*border-top: 1px solid #DDD;*/
  padding-top: 1em;
}
</style>
{% endblock %}

{% block body %}

{{block.super}}

<div class="row">

<div class="col-md-9">
  <div id="focus-area-wrapper">

    {% if source_invitation %}
      <div style="margin-bottom: 2em">
        <div id="source-invitation-show" style="text-align: right; margin-bottom: -1.5em; {% if not task.is_started %}display: none;{% endif %}">
          <a href="#" onclick="$('#source-invitation').fadeIn(); $('#source-invitation-show').hide(); return false;" style="color: #448; font-size: 85%">
            Show Invitation from {{source_invitation.from_user}}
          </a>
        </div>
        
        <div id="source-invitation" class="alert alert-warning alert-dismissible" {% if task.is_started %}style="display: none"{% endif %} role="alert">
          <button type="button" class="close" aria-label="Close" onclick="$('#source-invitation').hide(); $('#source-invitation-show').show();"><span aria-hidden="true">&times;</span></button>
          <strong>Invitation from {{source_invitation.from_user}}:</strong>
          {{source_invitation.text}}
        </div>
      </div>
    {% endif %}

    <form id="questionsform" {% if not write_priv %}class="disabled"{% endif %} autocomplete="off">

    <input type="hidden" name="method" value="save">

    {% if questions.0.question.spec.group %}
    <h1>{{questions.0.question.spec.group.title}}</h1>
    {% endif %}

    {% for q in questions %}
      {% include "question-widget.html" %}
    {% endfor %}

    {% if write_priv %}
          <div id="action-buttons" class="clearfix">

            {# Buttons to save or skip this question #}
            <div class="pull-left">
              <button id="save-button"
                type="submit" class="btn btn-success"
                onclick="$('form input[name=method]').val('save')">
                {% if q.question.spec.type == "interstitial" %}
                  Got it
                {% elif not request.GET.q %}
                  {# user is proceeding through the questions in order #}
                  Next
                {% else %}
                  {# user is visiting a specific question #}
                  Update
                {% endif %}
                &raquo;
              </button>

              {# This is DEBUG functionality for reverting a question to an un-answered state, which differs from being answered but with null via the Skip/Clear button. #}
              {% if answer_obj and DEBUG %}
                <button id="clear-button"
                  type="submit" class="btn btn-default"
                  onclick="$('form input[name=method]').val('clear')">
                    Mark as Unanswered
                    &raquo;
                  </button>
              {% endif %}
            </div> {# /.pull-left #}

          </div> <!-- /action-buttons -->
    {% endif %}

    </form>

    {% include "discussion/discussion.html" %}

    </div> <!-- /focus-area-wrapper -->

  </div> <!-- /col -->

  <div class="col-md-3">
    <div id="question-history-context" style="border:0px solid black; max-height: 550px; overflow-y:scroll; padding:4px;">
        <ul>
        {% if context %}
          <p>Progress:</p>
          {% include "task-progress-question-list.html" with previous="question" %}
          <div style="font-size: 10px; line-height: 120%; padding-left: 2em; color: #222;">
          <li>&middot;</li>
          <li>&middot;</li>
          <li>&middot;</li>
          </div>
          <li>
            ...and we&rsquo;re done
          </li>
        {% endif %}
        </ul>
    </div> <!-- /question-history-context -->
  </div>

</div> <!-- /row -->

{% if authoring_tool_enabled %}
{# should be in body so that it comes before the global error modal so that ajax errors show on top of this #}
{% include "authoring-tool-modal.html" %}
{% endif %}

{% endblock %}

{% block scripts %}

{% include "task-question-debug-links.html" %}

<script src="{% static "vendor/quill/quill.min.js" %}"></script>
<script src="{% static "js/quill_commonmark.js" %}"></script>

<script>
$(function() {
  var form = $("form#questionsform");

  {% include "question-widget-classes.js" %}


    {% if questions.0.discussion %}
    {# a discussion already exists, so show it #}
    start_a_discussion(true); // is idempotent
    {% elif history %}
    show_static_history({{history|json}});
    {% endif %}

    // CONTROL INITIALIZATION

    var question_widgets = {};

    function initialize_widget(key, spec, current_answer, skipped_reason, unsure, is_answerable, first) {
      var qdiv = $("#question-" + key);
      var widget_class = widgets[spec.type];
      var widget_instance = widget_class.initialize(
        key,
        qdiv.find(".widget"),
        spec,
        current_answer);
      var widget = {
        focus: function() { widget_class.focus(widget_instance); },
        validate_answer: function() { return widget_class.validate_answer(widget_instance, spec, current_answer); },
        value: function() { return widget_class.value(widget_instance); },
        on_input_changed: function(handler) { return widget_class.on_input_changed(widget_instance, handler); },
        disable_input_controls: function(disabled) { return widget_class.disable_input_controls(widget_instance, disabled); },
        user_has_entered_clearable_answer: function() { return widget_class.user_has_entered_clearable_answer(widget_instance); },
      };

      {% if write_priv %}
        {# If the first control is editable, give it focus. #}
        if (first)
          widget.focus();

        {# If the question was skipped, set the right skip button state. #}
        if (skipped_reason) {
          if (skipped_reason == "dont-know")
            qdiv.find('no-idea-button').addClass('active');
          else if (skipped_reason == "doesnt-apply")
            qdiv.find('.not-applicable-button').addClass('active');
          else
            qdiv.find('.not-now-button').addClass('active');
          widget.disable_input_controls(true);
        }

        if (unsure)
          qdiv.find('.not-sure-button').addClass('active');

        qdiv.find('.confidence-buttons .emoji').each(function() {
            $(this)
              .addClass("emojione-24-" + $(this).attr('data-sprite'))
              .addClass("_" + $(this).attr('data-code'));
          });
        qdiv.find('.confidence-buttons button:not([data-toggleable=false])')
          .click(function() {
            // Don't Know, Doesn't Apply, and Not Now
            // are mutually exclusive with the user
            // also providing an answer. If they typed
            // anything into a text field, or any field
            // that is resettable (e.g. radios aren't)
            // then show a message and stop.
            if (($(this).hasClass("no-idea-button")
                  || $(this).hasClass("not-applicable-button")
                  || $(this).hasClass("not-now-button"))
                && widget.user_has_entered_clearable_answer()) {
              show_modal_error(
                "",
                "Please clear your answer before selecting "
                + "“" + $(this).text().replace(/^\s+|\s+$/g, '') + ".” "
                + "Click “Not sure” to save an answer you will return to later.")
              return;
            }

            $(this).toggleClass('active');
            if ($(this).hasClass('active')) {
                // Don't Know, Doesn't Apply, and Not Now
                // are mutually exclusive.
                if ( $(this).hasClass("no-idea-button")
                  || $(this).hasClass("not-applicable-button")
                  || $(this).hasClass("not-now-button")) {
                    qdiv
                      .find('.no-idea-button, .not-applicable-button, .not-now-button, .not-sure-button')
                      .removeClass('active');
                    $(this).addClass('active');
                  }
            }

            // Controls are disabled when Don't Know, Doesn't Apply, or Not Now
            // are selected.
            widget.disable_input_controls(qdiv.find('.no-idea-button').hasClass('active') || qdiv.find('.not-applicable-button').hasClass('active') || qdiv.find('.not-now-button').hasClass('active'));
            update_save_button_enabled();
          });

          if (!is_answerable)
            widget.disable_input_controls(true);
      {% else %}
        {# If the control is not editable, make it disabled. #}
        widget.disable_input_controls(true);
      {% endif %}

      question_widgets[key] = widget;
    }

    {% for q in questions %}
    initialize_widget(
      "{{q.question.key|escapejs}}",
      {{q.question.spec|json}},
      {% if q.spec.type == "date" %}{{q.answer|json}}{% elif answer_obj %}true{% else %}false{% endif %},
      {{q.answer_obj.skipped_reason|json}},
      {{q.answer_obj.unsure|json}},
      {{q.is_answerable|json}},
      {{forloop.first|json}});
    {% endfor %}

    // BUTTON STATE

    function update_save_button_enabled() {
      // The save button is enabled just when the inputs are valid
      // and Don't Know, Doesn't Apply, Not Now aren't active (if they
      // are, the answer inputs aren't used).
      var ok = true;
      {% for q in questions %}
      if (typeof question_widgets["{{q.question.key|escapejs}}"].validate_answer() != "undefined"
        && $("#question-{{q.question.key|escapejs}}").find('.no-idea-button, .not-applicable-button, .not-now-button').filter('.active').length == 0)
        ok = false;
      {% endfor %}
      $('#save-button').prop('disabled', !ok);
    }

    update_save_button_enabled(); // run initially

    // register event handlers
    {% for q in questions %}
    question_widgets["{{q.question.key|escapejs}}"].on_input_changed(update_save_button_enabled);
    question_widgets["{{q.question.key|escapejs}}"].on_input_changed(record_interaction);
    {% endfor %}


  // SUBMIT

  form.on("submit", function() {
    // Assemble the form submission data. We could assign key-value pairs
    // to an object to submit to jQuery.ajax but file uploads require that
    // we use a FormData object. (And the rich text editor requires that we
    // call a function to get its value, btw, so just querying input elements
    // won't work either.)
    var data = new FormData();

    // List all of the questions we're saving.
    var questions = [{% for q in questions %}{{q.question.id}}{% if not forloop.last %},{% endif %}{% endfor %}];
    data.append("questions", questions.join(","));

    // Which submit button was pressed? In normal usage there is
    // only a Save button. When debugging, we have a Mark as Cleared
    // button that resets a question to a state of not even having
    // ever been answered.
    if (form.find('input[name=method]').val() == "clear") {
      data.append("method", "clear");
      ajax_with_indicator({
          url: "{{task.get_absolute_url|escapejs}}/_save",
          method: "POST",
          data: data,
          indicator_parent: $('#question'),
          keep_indicator_forever: true, // keep the ajax indicator up forever --- it'll go away when we issue the redirect
          success: function(res) {
            window.location = res.redirect;
          }
      });
      return false;
    }

    data.append("method", "save");

    function submit_question(id, key, title) {
      // Save skipped reason and unsure flag.
      var qdiv = $("#question-" + key);
      if (qdiv.find('.no-idea-button').hasClass('active')) {
        data.append("q" + id + "_skipped_reason", 'dont-know');
      } else if (qdiv.find('.not-applicable-button').hasClass('active')) {
        data.append("q" + id + "_skipped_reason", 'doesnt-apply');
      } else if (qdiv.find('.not-now-button').hasClass('active')) {
        data.append("q" + id + "_skipped_reason", 'come-back');
      } else {
        // Double check that everything is valid.
        var problem = question_widgets[key].validate_answer();
        if (problem) {
          alert(tile + ": " + problem);
          return false;
        }

        var value = question_widgets[key].value();
        if (!Array.isArray(value))
          data.append("q" + id + "_value", value);
        else
          value.forEach(function(item) {
            data.append("q" + id + "_value", item);
          })
      }

      // Set the unsure flag.
      data.append("q" + id + "_unsure",
        qdiv.find('.not-sure-button').hasClass('active') ? "yes" : "");

      return true;
    }

    {% for q in questions %}
    if (!submit_question({{q.question.id}}, "{{q.question.key|escapejs}}", "{{q.question.spec.title|escapejs}}"))
      return false;
    {% endfor %}

    ajax_with_indicator({
        url: "{{task.get_absolute_url|escapejs}}/_save",
        method: "POST",
        data: data,
        indicator_parent: $('#questionsform'),
        keep_indicator_forever: true, // keep the ajax indicator up forever --- it'll go away when we issue the redirect
        success: function(res) {
          window.location = res.redirect;
        }
    });

    // don't do an actual <form> submit
    return false;
  });
})

{% if can_review %}
function update_review_status(elem, answerid) {
  var reviewed = $(elem).val();
  $(elem).blur();
  ajax_with_indicator({
      url: "/tasks/_update_reviewed_state",
      method: "POST",
      data: {
        answer: answerid,
        reviewed: reviewed
      }
  });
}
{% endif %}

function start_a_discussion(is_page_load) {
    $.ajax({
        url: "{% url 'start_a_discussion' %}",
        method: "POST",
        data: {
            task: {{task.id}},
            question: "{{questions.0.question.id|escapejs}}"
        },
        success: function(res) {
          // load the discussion
          display_discussion(res, is_page_load);

          // scroll to it if this is from a user action
          if (!is_page_load)
            smooth_scroll_to($("#discussion"));
        }
    })
}

function show_static_history(history) {
  // There's no discussion yet, but we do have activity.
  $('#discussion').show();
  history.forEach(function(item) {
      render_event(item)
    });
}


{% if send_invitation %}
function invite_user_to_discussion() {
  show_invite_modal(
    'Invite to Discussion',
    'Invite a colleague to join the discussion. They will be a guest of this discussion if they are not added to the project team.',
    {{send_invitation|json}},
    'Please join our discussion about ' + discussion_info.title + ' in ' + discussion_info.project.title + '.',
    {
      project: discussion_info.project.id,
      into_discussion: discussion_info.id
    }
  );
  return false;
}
{% endif %}

var sent_first_interaction = false;
function record_interaction() {
  if (sent_first_interaction)
    return;
  $.ajax({
    url: "{% url 'task_instrumentation_record_interaction' %}",
    method: "POST",
    data: {
      task: {{task.id}},
      question: {{questions.0.question.id}}
    }
  })
  sent_first_interaction = true;
}
</script>

{% if authoring_tool_enabled %}
<script src="{% static "vendor/js-yaml.min.js" %}"></script>
<script src="{% static "js/authoring_tool.js" %}"></script>
<style>.dropdown-menu.textcomplete-dropdown { z-index: 99999 !important; }</style> {# show over modal #}
<script>
$(function() {
  init_authoring_tool({
    task: {{task.id}},
    module: {{task.module.spec|json}},
    questions: {
      {% for question in questions %}
      {% with q=question.question %}
      {{q.key}}: {
        spec: {{q.spec|json}},
        choices: "{{q.choices_as_csv|escapejs}}",
        answer_type_module_id: {% if q.answer_type_module %}{{q.answer_type_module.id}}{% else %}null{% endif %}
      }{% if not forloop.last %},{% endif %}
      {% endwith %}
      {% endfor %}
    },
    answer_type_modules: [{% for m in get_referenceable_modules %}
      { id: "{{m.id}}", title: "{{m.title|escapejs}} ({{m.module_name}})" }{% if not forloop.last %},{% endif %}
      {% endfor %}],
    autocomplete_questions: { {% for q in q.module.get_questions %}
      "{{q.key|escapejs}}": "{{q.value_explanation|truncatechars:50|escapejs}}"{% if not forloop.last %}, {% endif %}{% endfor %}
    }
  });
});
</script>
{% endif %}

{% endblock %}