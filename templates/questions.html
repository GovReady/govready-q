{% extends "base.html" %}
{% load static %}
{% load q %}

{% block title %}
Question editor
{% endblock %}

{% block head %}
<meta name="description" content="Edit compliance app questioonaire.">

<link href="{% static "vendor/emojione/emojione-sprite-24.min.css" %}" rel="stylesheet">
{% if q.spec.type == "longtext" %}
  <link href="{% static "vendor/quill/quill.snow.css" %}" rel="stylesheet">
{% endif %}

{{block.super}}

<style>

  h1 {
    margin: 4px 0 18px 0;
    font-size: 22px;
    font-weight: bold;
  }

  /*  .form-control {
    font-size: 14pt;
    height: 34pt;
  }*/

  .question {
    font-size: 10pt;
  }
    .question form.disabled label {
      color: #777;
      cursor: not-allowed;
    }

  .question-prompt blockquote {
    font-size: inherit;
  }

  .question-prompt {
    margin: 10px 10px 10px 0px;
    font-weight: 700;
  }

  /* since prompts will likely use Markdown ##'s to delimit sections,
      which we render as h3 because we demote all levels, re-adjust
      styles */
  .question-prompt h3 {
    font-size: 110%;
    font-weight: bold;
  }

  {% if q.spec.type == "module" %}
  .question .radio label {
    margin: .25em 0;
  }
  {% endif %}

  {% if q.spec.type == "interstitial" %}
    .question img {
      display: block; /* so that horizontal auto margin centers */
      margin: 30px auto;
    }
  {% endif %}

  {% if q.spec.type == "longtext" %}
  .question .ql-container {
    font-size: 10pt !important; /* override default quill style */
    /*font-family: trebuchet ms;*/
  }
  .question .ql-container p {
    margin-bottom: .75em;
  }
    .question .ql-container p:last-child {
      margin-bottom: 0;
    }
  {% endif %}

  label .onhover { display: none; }
  label:hover .onhover { display: inline; }


  #reference-text-wrapper *:first-child { margin-top: 0; }

  /* Legacy background and focus area styling for question pages */
  body { /*background-color: rgb(247,247,247);*/ }

  #focus-area-wrapper {
    border-radius: 3px;
    border: 3px solid rgb(204, 204, 204);
    padding: 2em 2em 3em 2em;
    background-color: white;
    /*background-color: rgba(253,253,253,1);*/
    /* on mobile, space between columns */
    margin-bottom: 30px;
    font-size: 10pt;
  }

  .datagrid-text {
    font-size: 0.8em;
  }

  .datagrid-text-select {
    font-size: 1.0em;
  }

  textarea {
    padding: 12px 12px 12px 12px;
  }

  input, textarea, select {
    margin-bottom: 8px;
  }

  label {
    margin-top: 8px;
  }

  /* styles for the table */
  .question_grid td { padding: 10px 10px 10px 0; }
  .question_grid tr { border-bottom:1px solid #ccc; padding: 5px; }
  .question_grid th { font-size:.8em;}
  .question_grid th.order_col { width: 5%; }
  .question_grid th.key_col { width: 20%; }
  .question_grid th.title_col { width: 30%; }
  .question_grid th.type_col { width: 20%; }
  .question_grid th.prompt_col { width: 25%; }

  .leftbox { display:block; font-size:.9em; padding:.5em; border:1px solid #E5E5E5; background:#F8F8F8; margin-bottom:.5em; color:#808080; }
  .tot_q {  font-size:.8em; }

  .leftbox:hover { background:#DCDCDC; color:#505050; }

  .hidden-field { display: none; }


</style>
{% endblock %}

{% block body %}
{{block.super}}

<h1>page title</h1>

<div class="row" style="width: 100%; margin: auto; margin-bottom: 12px;">
<div style="padding-left:15px;">
  <h2 style="font-weight:bold; padding-top:0; margin:0;">
    {{ module.app.catalog_metadata.title }}
    {% if app.icon %}<img src="{{ app.icon }}" class="img-responsive" style="height:60px;" alt="App Icon">{% endif %}
  </h2><span style="font-size:1em;">Version {{ module.app.version_number }}</span>
</div>
</div>
<br />
<div class="row" style="width: 100%;  margin: auto; ">
<div class="col-md-2">

  {% with app=module.app %}

    {% for m in app.modules.all %}

      {% if not forloop.last %}
      <a href="/tasks/module/{{m.id}}/questions" style="text-decoration:none;"><div class="leftbox">
        {{ m.title }}<br /><span class="tot_q">{{ m.questions.all|length }} question{{ m.questions.all|pluralize }}</span>
          </div></a>
      {% endif %}

    {% endfor %}

  {% endwith %}

</div>
<div class="col-md-10" style="padding-left:2em;">
  <p><strong>{{ module.title }}</strong> module contains <strong>{{ module_questions|length }} questions</strong>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; <a href="#">Add a Question</a><br />
  </p>

    <table class="question_grid"><tr><th class="order_col">Order</th><th class="key_col">Key</th><th class="title_col">Title</th><th class="type_col">Type</th><th class="prompt_col">Prompt</th></tr>
      {% for q in module_questions %}
        <tr><td>{{q.definition_order}}</td><td>{{q.key}}</td><td>{{q.spec.title}}</td><td>{{q.spec.type}}</td><td>{{q.spec.prompt|truncatechars:50}}</td>

          <td>
            <form autocomplete="off" action="" method="post" class="question-form" onsubmit="return false;">
              <input type="hidden" name="method" value="save">
              <input type="hidden" name="q_id" value="{{q.id}}">
              <input type="hidden" name="q_key" value="{{q.key}}">
              <textarea class="hidden-field" name="q_spec_obj">{{q.spec|json}}</textarea>
              <textarea class="hidden-field" name="m_spec_obj">{{module.spec|json}}</textarea>
              <textarea class="hidden-field" name="answer_type_modules">"[{% for m in q.module.get_referenceable_modules %}
      { id: "{{m.id}}", title: "{{m.title|escapejs}} ({{m.module_name}})" }{% if not forloop.last %},{% endif %}
      {% endfor %}]"</textarea>
              <textarea class="hidden-field" name="autocomplete_questions">{ {% for q in q.module.get_questions %}
      "{{q.key|escapejs}}": "{{q.value_explanation|truncatechars:50|escapejs}}"{% if not forloop.last %}, {% endif %}{% endfor %}
    }</textarea>

              <p>&nbsp;</p>
              <div class="form-group col-sm-12">
                <input class="pull-right submitform btn btn-link" name="submit" type="submit" id="submit" value="edit">
              </div>
            </form>

            <!-- <a id="show_question_authoring_tool" href="#" onclick=" console.log('1'); return false;">
              <span class="glyphicon glyphicon-pencil task-glypicons" title="Edit"></span>
            </a> -->

          </td>
        </tr>
      {% endfor %}
    </table>
  </div>

  </div>


<!-- hiding code here -->
<div style="display:none;">
  <form autocomplete="off" action="" method="post" class="comment-form" onsubmit="return false;">
    <div>Question {{ forloop.counter0 }}</div>
    <div class="form-group">
      <input type="hidden" name="question" value="{{q.id}}">
      <input type="hidden" name="method" value="save">
    </div>

    <div class="form-group">
        <label for="key" class="col-sm-2 control-label">Key</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="key" name="key" value="{{q.key}}">
        </div>
    </div>

      <div class="form-group">
        <label for="authoring_tool_qtitle" class="col-sm-2 control-label">Title</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="authoring_tool_qtitle" name="title" value="{{q.spec.title}}">
        </div>
      </div>

    <div class="form-group">
        <label for="prompt" class="col-sm-2 control-label">Prompt</label>
        <div class="col-sm-10">
          <textarea class="form-control" name="prompt" style="width: 100%; min-height: 100px;">{{ q.spec.prompt }}</textarea>
        </div>
    </div>

      <!--
      <div class="form-group">
        <label for="authoring_tool_qtitle" class="col-sm-2 control-label">Prompt</label>
        <div class="col-sm-10">
          <textarea id="authoring_tool_qtitle" name="title" style="width:100%;">{{q.spec.prompt}}</textarea>
          <span class="help-block">Prompt for question</span>
        </div>
      </div>
      -->

      <div class="form-group">
        <label for="authoring_tool_type" class="col-sm-2 control-label">Type</label>
        <div class="col-sm-10">
          <select class="form-control" id="authoring_tool_type" onchange="_val = $(this).val(); $('#authoring_tool_q_type_options>div, #authoring_tool_q_type_options .toggled').each(function() { $(this)[$(this).hasClass('authoring_q_type_' + _val) ? 'fadeIn' : 'hide']() });" name="type">
            <optgroup label="Text Questions">
              <option value="text" {% if q.spec.type == "text" %}selected{% endif %}>Text (Single Line)</option>
              <option value="password" {% if q.spec.type == "password" %}selected{% endif %}>Password</option>
              <option value="email-address" {% if q.spec.type == "email-address" %}selected{% endif %}>Email Address</option>
              <option value="url" {% if q.spec.type == "url" %}selected{% endif %}>Web Address (URL)</option>
              <option value="longtext" {% if q.spec.type == "longtext" %}selected{% endif %}>Paragraph (Rich Text/Markdown)</option>
            </optgroup>
            <optgroup label="Choice Questions">
              <option value="date" {% if q.spec.type == "date" %}selected{% endif %}>Date</option>
              <option value="yesno" {% if q.spec.type == "yesno" %}selected{% endif %}>Yes/No</option>
              <option value="choice" {% if q.spec.type == "choice" %}selected{% endif %}>Single Choice</option>
              <option value="choice-from-data" {% if q.spec.type == "choice-from-data" %}selected{% endif %}>Single Choice from Data</option>
              <option value="multiple-choice" {% if q.spec.type == "multiple-choice" %}selected{% endif %}>Multiple Choice</option>
              <option value="multiple-choice-from-data" {% if q.spec.type == "multiple-choice-from-data" %}selected{% endif %}>Multiple Choice from Data</option>
              <option value="datagrid" {% if q.spec.type == "datagrid" %}selected{% endif %}>Datagrid</option>
            </optgroup>
            <optgroup label="Number Questions">
              <option value="integer" {% if q.spec.type == "integer" %}selected{% endif %}>Integer</option>
              <option value="real" {% if q.spec.type == "real" %}selected{% endif %}>Any Number</option>
            </optgroup>
            <optgroup label="Media Questions">
              <option value="interstitial" {% if q.spec.type == "interstitial" %}selected{% endif %}>Interstitial</option>
              <option value="file" {% if q.spec.type == "file" %}selected{% endif %}>File Upload</option>
            </optgroup>
          </select>
        </div>
      </div>
      <!--
      <p>&nbsp;</p>
      <div class="form-group">
        <label for="authoring_tool_qid" class="col-sm-2 control-label">ID</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="authoring_tool_qid" pattern="[a-zA-Z_][a-zA-Z0-9_]*" name="newid" value="{{q.spec.id}}">
          <span class="help-block">Identifier for question used in templates and the API.</span>
        </div>
      </div> -->

    <div class="form-group">
        <label for="definition_order" class="col-sm-2 control-label">Order</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="definition_order" name="definition_order" value="{{q.definition_order}}">
        </div>
    </div>

    <p>&nbsp;</p>
    <div class="form-group col-sm-12">
      <input class="pull-right" name="submit" class="submitform" type="submit" id="submit" value="save">
      <div class="success-msg pull-right" style="display: inline; margin: 4px 20px 0px 0px; color: green;"></div>
    </div>

    <div>&nbsp;</div>
    <div class="pull-right">
      {% if user.is_staff %}<a href="{{ADMIN_ROOT_URL}}/guidedmodules/modulequestion/{{q.id}}" target="_blank" style="color:#bbb; font-size:9pt;">{% endif %}
      <div id="debug-question-key" title="guidedmodules/modulequestion/{{q.id}}">Edit database</div>{% if user.is_staff %}</a>{% endif %}
      <div class="pull-right help" style="color:#bbb; font-size:9pt;">Add question</div>
    </div>

  </form>
  </div>
<!-- end hidden code -->

<script>
$('.question-form').on('submit', function(e) {
  e.preventDefault();
  var formElm = $(this)
  var q_id = formElm.find('input[name="q_id"]').val();
  var q_key = formElm.find('input[name="q_key"]').val();
  console.log(q_id);
  // console.log(q_key);

  var q_spec_obj = JSON.parse(formElm.find('textarea[name="q_spec_obj"]').val());
  // console.log(q_spec_obj);

  // console.log('q_key:'+q_key);
  var questions = {}
  questions[q_key] = { spec: q_spec_obj,
                      // choices: "{{q.choices_as_csv|escapejs}}",
                      answer_type_module_id: null
                    }
  console.log('questions:');
  console.log(questions);
  var m_spec_obj = JSON.parse(formElm.find('textarea[name="m_spec_obj"]').val());
  // console.log(m_spec_obj);

  // answer_type_modules = JSON.parse(formElm.find('input[name="answer_type_modules"]').val());
  // autocomplete_questions = JSON.parse(formElm.find('input[name="autocomplete_questions"]').val());

  // var data = formElm.serializeArray();
  // console.log(data);

  // TODO remove task: key as not needed
  init_authoring_tool({
    task: 3,
    module: m_spec_obj,
    questions: questions,
    answer_type_modules: [],
    autocomplete_questions: {}
  });

  show_question_authoring_tool(q_id, q_key);
});

// Previous question form
// $('.comment-form').on('submit', function(e) {
//   e.preventDefault();
//   var formElm = $(this)
//   var prompt = formElm.find('textarea[name="prompt"]').val();
//   console.log(prompt);
//   var data = formElm.serializeArray();
//   data.push( { name: "module_id", value: {{ module.id }} } );
//   data.push( { name: "question", value: formElm.find('input[name="key"]').val() } );
//   console.log(data);
//   ajax_with_indicator({
//       url: "/tasks/_authoring_tool/edit-question-new",
//       method: "POST",
//       data: data,
//       keep_indicator_forever: false,
//       success: function(res) {
//         // Modal can stay up until the redirect finishes.
//         console.log(res)
//         if (res['status'] == "success") {
//           formElm.find('.success-msg').fadeIn().text('saved')
//         }
//         // window.location = res.redirect;
//         // if (window.location.hash.length > 1)
//           // window.location.reload(); // if there is a # in the URL, the browser won't actually reload
//       }
//   });
//   setTimeout(function () {
//       formElm.find('.success-msg').fadeOut().text('');
//   }, 2000);
//   return false; // Stop form reloading page
// });
</script>

{% if authoring_tool_enabled %}
  {% include "authoring-tool-modal.html" %}
  <script src="{% static 'vendor/js-yaml.min.js' %}"></script>
  <script src="{% static 'js/authoring_tool.js' %}"></script>
  <style>.dropdown-menu.textcomplete-dropdown { z-index: 99999 !important; }</style> {# show over modal #}
{% endif %}

{% endblock %}

{% block scripts %}
    {{ block.super }}


{% endblock %}
